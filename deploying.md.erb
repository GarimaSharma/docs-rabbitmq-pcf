---
breadcrumb: RabbitMQ for Pivotal CF Documentation
title: Deploying the RabbitMQ Service
---

## Default Deployment
Deploying RabbitMQ for Pivotal CF through Ops Manager will deploy a RabbitMQ cluster of **2 nodes** as default. 

The deployment includes a single load balancer `haproxy` which spreads connections on all of the default ports, for all of the shipped plugins across all of the machines within the cluster.

The deployment will occur in a single availability zone (AZ).

<%= image_tag("images/deployment_default.jpeg") %>

### Considerations for this deployment

* Provides HA for RabbitMQ nodes to avoid data loss
* HAProxy is a single point of failure (SPOF)
* The entire deployment is in a single AZ, which does not protect against external failures such as hardware, networking etc

## Recommended Deployment

It is recommended that RabbitMQ is deployed across at least two availability zones. 

The HAProxy job instance count should also be increased to match the number of AZs to ensure there is a HAProxy located in each AZ.
This removes the HAProxy SPOF and provides further redundancy. 

<%= image_tag("images/deployment_recommended.jpeg") %>

In the above diagram you can see that you can now suffer the failure of a single HAProxy and single RabbitMQ node and still keep your cluster online and applications connected. 

### Upgrading to this deployment from a single AZ deployment

It is **not** possible to upgrade to this setup from the default deployment across a single AZ. 

This is because the AZ setup cannot be changed once the tile has being deployed for the first time, this is to protect against data loss when moving jobs between AZs. 

### Upgrading to this deployment from a multi AZ deployment

If you have deployed the tile across two AZs, but with a single HAProxy instance you can migrate to this setup as follows:

1. Deploy an additional HAProxy instance through OpsManager
2. New or re-bound applications to the RabbitMQ service will see the IPs of both HAProxys immediately
3. Existing bound applications will continue to work, but only using the previously deployed HAProxy IP Address. They can be re-bound as required at your discretion. 

### Considerations for this deployment

* Requires IaaS configuration for availability zones ahead of deploying the RabbitMQ tile
* Application developers will be handed the IPs of each deployed HAProxy in their environment variables


